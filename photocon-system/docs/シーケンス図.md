# フォトコンテストシステム シーケンス図

## 1. 作品投稿フロー

```
┌─────────┐     ┌─────────────┐     ┌───────────────┐     ┌──────────────────┐     ┌─────────────┐
│  ユーザー  │     │  Submit Page │     │  /api/entries │     │ Supabase Storage │     │ Supabase DB │
└────┬────┘     └──────┬──────┘     └───────┬───────┘     └────────┬─────────┘     └──────┬──────┘
     │                  │                     │                      │                      │
     │  フォーム入力      │                     │                      │                      │
     │─────────────────>│                     │                      │                      │
     │                  │                     │                      │                      │
     │  写真ドロップ      │                     │                      │                      │
     │─────────────────>│                     │                      │                      │
     │                  │                     │                      │                      │
     │  投稿ボタンクリック  │                     │                      │                      │
     │─────────────────>│                     │                      │                      │
     │                  │                     │                      │                      │
     │                  │ バリデーション         │                      │                      │
     │                  │ (nickname, email,   │                      │                      │
     │                  │  file size/type)    │                      │                      │
     │                  │                     │                      │                      │
     │                  │  POST FormData      │                      │                      │
     │                  │────────────────────>│                      │                      │
     │                  │                     │                      │                      │
     │                  │                     │  ファイルアップロード    │                      │
     │                  │                     │─────────────────────>│                      │
     │                  │                     │                      │                      │
     │                  │                     │  publicUrl返却       │                      │
     │                  │                     │<─────────────────────│                      │
     │                  │                     │                      │                      │
     │                  │                     │  INSERT entries       │                      │
     │                  │                     │  (status: pending)   │                      │
     │                  │                     │─────────────────────────────────────────────>│
     │                  │                     │                      │                      │
     │                  │                     │  entry data          │                      │
     │                  │                     │<─────────────────────────────────────────────│
     │                  │                     │                      │                      │
     │                  │  success response   │                      │                      │
     │                  │<────────────────────│                      │                      │
     │                  │                     │                      │                      │
     │  成功メッセージ表示  │                     │                      │                      │
     │<─────────────────│                     │                      │                      │
     │                  │                     │                      │                      │
```

---

## 2. ギャラリー表示フロー

```
┌─────────┐     ┌──────────────┐     ┌─────────────┐     ┌────────────┐     ┌─────────────────┐
│  ユーザー  │     │  Gallery Page │     │ Supabase DB │     │ GalleryGrid │     │ LightboxModal │
└────┬────┘     └──────┬───────┘     └──────┬──────┘     └─────┬──────┘     └────────┬────────┘
     │                  │                     │                   │                      │
     │  /gallery アクセス │                     │                   │                      │
     │─────────────────>│                     │                   │                      │
     │                  │                     │                   │                      │
     │                  │ SELECT entries      │                   │                      │
     │                  │ (email除外)          │                   │                      │
     │                  │ WHERE status=       │                   │                      │
     │                  │   'approved'        │                   │                      │
     │                  │────────────────────>│                   │                      │
     │                  │                     │                   │                      │
     │                  │ entries data        │                   │                      │
     │                  │<────────────────────│                   │                      │
     │                  │                     │                   │                      │
     │                  │ props: entries      │                   │                      │
     │                  │────────────────────────────────────────>│                      │
     │                  │                     │                   │                      │
     │  ページ表示        │                     │                   │                      │
     │<─────────────────│                     │                   │                      │
     │                  │                     │                   │                      │
     │  カード クリック    │                     │                   │                      │
     │───────────────────────────────────────────────────────────>│                      │
     │                  │                     │                   │                      │
     │                  │                     │                   │ setSelectedEntry    │
     │                  │                     │                   │─────────────────────>│
     │                  │                     │                   │                      │
     │  モーダル表示       │                     │                   │                      │
     │<──────────────────────────────────────────────────────────────────────────────────│
     │                  │                     │                   │                      │
```

---

## 3. 投票フロー

```
┌─────────┐     ┌────────────┐     ┌──────────┐     ┌────────────┐     ┌─────────────┐
│  ユーザー  │     │ VoteButton │     │ useVote  │     │ /api/votes │     │ Supabase DB │
└────┬────┘     └─────┬──────┘     └────┬─────┘     └─────┬──────┘     └──────┬──────┘
     │                 │                  │                 │                   │
     │ ページ表示時       │                  │                 │                   │
     │                 │ checkVoteStatus() │                 │                   │
     │                 │─────────────────>│                 │                   │
     │                 │                  │                 │                   │
     │                 │                  │ GET /api/votes  │                   │
     │                 │                  │ ?entryId=xxx    │                   │
     │                 │                  │────────────────>│                   │
     │                 │                  │                 │                   │
     │                 │                  │                 │ SELECT votes      │
     │                 │                  │                 │ WHERE entry_id=   │
     │                 │                  │                 │────────────────── >│
     │                 │                  │                 │                   │
     │                 │                  │                 │ count, hasVoted   │
     │                 │                  │                 │<──────────────────│
     │                 │                  │                 │                   │
     │                 │                  │ {voteCount,     │                   │
     │                 │                  │  hasVoted}      │                   │
     │                 │                  │<────────────────│                   │
     │                 │                  │                 │                   │
     │                 │ state更新         │                 │                   │
     │                 │<─────────────────│                 │                   │
     │                 │                  │                 │                   │
     │ ハートボタン表示    │                  │                 │                   │
     │<────────────────│                  │                 │                   │
     │                 │                  │                 │                   │
     │ クリック（投票）    │                  │                 │                   │
     │────────────────>│                  │                 │                   │
     │                 │                  │                 │                   │
     │                 │ vote()           │                 │                   │
     │                 │─────────────────>│                 │                   │
     │                 │                  │                 │                   │
     │                 │                  │ POST /api/votes │                   │
     │                 │                  │ {entryId}       │                   │
     │                 │                  │────────────────>│                   │
     │                 │                  │                 │                   │
     │                 │                  │                 │ 1. エントリー確認    │
     │                 │                  │                 │    status=approved │
     │                 │                  │                 │────────────────── >│
     │                 │                  │                 │                   │
     │                 │                  │                 │ 2. 投票期間確認     │
     │                 │                  │                 │    voting_start   │
     │                 │                  │                 │    voting_end     │
     │                 │                  │                 │────────────────── >│
     │                 │                  │                 │                   │
     │                 │                  │                 │ 3. voter_identifier│
     │                 │                  │                 │    生成            │
     │                 │                  │                 │    SHA256(ip+     │
     │                 │                  │                 │      entryId)     │
     │                 │                  │                 │                   │
     │                 │                  │                 │ 4. INSERT votes   │
     │                 │                  │                 │────────────────── >│
     │                 │                  │                 │                   │
     │                 │                  │                 │ 5. 投票数カウント   │
     │                 │                  │                 │────────────────── >│
     │                 │                  │                 │                   │
     │                 │                  │ {voteCount}     │                   │
     │                 │                  │<────────────────│                   │
     │                 │                  │                 │                   │
     │                 │ state更新         │                 │                   │
     │                 │ hasVoted=true    │                 │                   │
     │                 │<─────────────────│                 │                   │
     │                 │                  │                 │                   │
     │ 投票済み表示       │                  │                 │                   │
     │<────────────────│                  │                 │                   │
     │                 │                  │                 │                   │
```

---

## 4. 管理者 エントリー承認フロー

```
┌─────────┐     ┌──────────────────┐     ┌─────────────────────┐     ┌─────────────┐
│  管理者   │     │ Admin Entries Page │     │ Server Action        │     │ Supabase DB │
└────┬────┘     └────────┬─────────┘     └──────────┬──────────┘     └──────┬──────┘
     │                    │                          │                       │
     │ /admin/entries     │                          │                       │
     │───────────────────>│                          │                       │
     │                    │                          │                       │
     │                    │ SELECT entries           │                       │
     │                    │ (Service Role Key)       │                       │
     │                    │──────────────────────────────────────────────────>│
     │                    │                          │                       │
     │                    │ entries (全データ)        │                       │
     │                    │<──────────────────────────────────────────────────│
     │                    │                          │                       │
     │ 一覧表示            │                          │                       │
     │<───────────────────│                          │                       │
     │                    │                          │                       │
     │ 「承認」クリック      │                          │                       │
     │───────────────────>│                          │                       │
     │                    │                          │                       │
     │                    │ updateEntryStatus        │                       │
     │                    │ (id, 'approved')         │                       │
     │                    │─────────────────────────>│                       │
     │                    │                          │                       │
     │                    │                          │ UPDATE entries        │
     │                    │                          │ SET status='approved' │
     │                    │                          │ WHERE id=xxx          │
     │                    │                          │──────────────────────>│
     │                    │                          │                       │
     │                    │                          │ success               │
     │                    │                          │<──────────────────────│
     │                    │                          │                       │
     │                    │                          │ revalidatePath        │
     │                    │                          │ (/admin/entries,      │
     │                    │                          │  /gallery)            │
     │                    │                          │                       │
     │                    │ success                  │                       │
     │                    │<─────────────────────────│                       │
     │                    │                          │                       │
     │                    │ router.refresh()         │                       │
     │                    │                          │                       │
     │ UI更新              │                          │                       │
     │<───────────────────│                          │                       │
     │                    │                          │                       │
```

---

## 5. Instagram自動収集フロー（Cron）

```
┌──────────────┐     ┌──────────────────┐     ┌─────────────────────┐     ┌────────────────┐     ┌─────────────┐
│ Vercel Cron  │     │ /api/cron/collect │     │ PhotoContestCollector │     │ InstagramAPI   │     │ Supabase DB │
└──────┬───────┘     └────────┬─────────┘     └──────────┬──────────┘     └───────┬────────┘     └──────┬──────┘
       │                      │                          │                        │                     │
       │ GET (CRON_SECRET)    │                          │                        │                     │
       │─────────────────────>│                          │                        │                     │
       │                      │                          │                        │                     │
       │                      │ Bearer Token検証         │                        │                     │
       │                      │                          │                        │                     │
       │                      │ collectAll()             │                        │                     │
       │                      │─────────────────────────>│                        │                     │
       │                      │                          │                        │                     │
       │                      │                          │ SELECT contests        │                     │
       │                      │                          │ WHERE status='active'  │                     │
       │                      │                          │────────────────────────────────────────────>│
       │                      │                          │                        │                     │
       │                      │                          │ active contests        │                     │
       │                      │                          │<────────────────────────────────────────────│
       │                      │                          │                        │                     │
       │                      │                          │ ┌───────────────────────────────────────┐   │
       │                      │                          │ │ LOOP: 各コンテストのハッシュタグ          │   │
       │                      │                          │ └───────────────────────────────────────┘   │
       │                      │                          │                        │                     │
       │                      │                          │ getHashtagId           │                     │
       │                      │                          │ (hashtag)              │                     │
       │                      │                          │───────────────────────>│                     │
       │                      │                          │                        │                     │
       │                      │                          │                        │ Graph API          │
       │                      │                          │                        │ /ig_hashtag_search │
       │                      │                          │                        │                     │
       │                      │                          │ hashtagId              │                     │
       │                      │                          │<───────────────────────│                     │
       │                      │                          │                        │                     │
       │                      │                          │ getRecentHashtagMedia  │                     │
       │                      │                          │ (hashtagId)            │                     │
       │                      │                          │───────────────────────>│                     │
       │                      │                          │                        │                     │
       │                      │                          │                        │ Graph API          │
       │                      │                          │                        │ /recent_media      │
       │                      │                          │                        │                     │
       │                      │                          │ media[]                │                     │
       │                      │                          │<───────────────────────│                     │
       │                      │                          │                        │                     │
       │                      │                          │ 日付範囲フィルタ          │                     │
       │                      │                          │ カテゴリマッピング        │                     │
       │                      │                          │                        │                     │
       │                      │                          │ UPSERT entries         │                     │
       │                      │                          │ (instagram_media_idで  │                     │
       │                      │                          │  重複排除)              │                     │
       │                      │                          │────────────────────────────────────────────>│
       │                      │                          │                        │                     │
       │                      │                          │ INSERT collection_logs │                     │
       │                      │                          │────────────────────────────────────────────>│
       │                      │                          │                        │                     │
       │                      │ results                  │                        │                     │
       │                      │<─────────────────────────│                        │                     │
       │                      │                          │                        │                     │
       │ response             │                          │                        │                     │
       │<─────────────────────│                          │                        │                     │
       │                      │                          │                        │                     │
```

---

## 6. TOPページ表示フロー

```
┌─────────┐     ┌───────────────┐     ┌─────────────┐
│  ユーザー  │     │   Home Page   │     │ Supabase DB │
└────┬────┘     └───────┬───────┘     └──────┬──────┘
     │                   │                    │
     │  / アクセス        │                    │
     │──────────────────>│                    │
     │                   │                    │
     │                   │ SELECT contests    │
     │                   │ WHERE status IN    │
     │                   │ ('active','voting')│
     │                   │───────────────────>│
     │                   │                    │
     │                   │ contest            │
     │                   │<───────────────────│
     │                   │                    │
     │                   │ SELECT entries     │
     │                   │ (email除外)         │
     │                   │ WHERE status=      │
     │                   │   'approved'       │
     │                   │ ORDER BY           │
     │                   │   sort param       │
     │                   │ LIMIT 8            │
     │                   │───────────────────>│
     │                   │                    │
     │                   │ entries (8件)      │
     │                   │<───────────────────│
     │                   │                    │
     │ ページレンダリング    │                    │
     │ - バナー            │                    │
     │ - ヒーロー          │                    │
     │ - 応募作品(8件)     │                    │
     │ - CTA             │                    │
     │<──────────────────│                    │
     │                   │                    │
     │ ソート切替クリック   │                    │
     │ (?sort=popular)   │                    │
     │──────────────────>│                    │
     │                   │                    │
     │                   │ 再度SELECT         │
     │                   │ ORDER BY like_count│
     │                   │───────────────────>│
     │                   │                    │
     │ 再レンダリング       │                    │
     │<──────────────────│                    │
     │                   │                    │
```

---

## 7. データフロー概要図

```
┌────────────────────────────────────────────────────────────────────────────────┐
│                              システム全体データフロー                               │
└────────────────────────────────────────────────────────────────────────────────┘

                                    ┌─────────────┐
                                    │  Instagram  │
                                    │  Graph API  │
                                    └──────┬──────┘
                                           │
                                           │ ハッシュタグ投稿取得
                                           │
                                           ▼
┌─────────────┐              ┌─────────────────────────┐              ┌─────────────┐
│   ユーザー    │              │      Next.js App        │              │   管理者    │
│             │              │                         │              │             │
│ ・投稿       │─────────────>│  ┌─────────────────┐    │<─────────────│ ・承認/却下  │
│ ・閲覧       │              │  │   API Routes    │    │              │ ・収集実行   │
│ ・投票       │<─────────────│  │  /api/entries   │    │──────────────│ ・統計確認   │
│             │              │  │  /api/votes     │    │              │             │
└─────────────┘              │  │  /api/contests  │    │              └─────────────┘
                             │  │  /api/instagram │    │
                             │  └────────┬────────┘    │
                             │           │             │
                             │           ▼             │
                             │  ┌─────────────────┐    │
                             │  │  Server Actions │    │
                             │  │ updateEntry     │    │
                             │  │ Status          │    │
                             │  └────────┬────────┘    │
                             │           │             │
                             └───────────┼─────────────┘
                                         │
                                         ▼
                             ┌─────────────────────────┐
                             │       Supabase          │
                             │                         │
                             │  ┌─────────────────┐    │
                             │  │    PostgreSQL   │    │
                             │  │                 │    │
                             │  │  - contests     │    │
                             │  │  - categories   │    │
                             │  │  - entries      │    │
                             │  │  - votes        │    │
                             │  │  - collection   │    │
                             │  │    _logs        │    │
                             │  └─────────────────┘    │
                             │                         │
                             │  ┌─────────────────┐    │
                             │  │    Storage      │    │
                             │  │                 │    │
                             │  │  - entries/     │    │
                             │  │    {contestId}/ │    │
                             │  │    {fileName}   │    │
                             │  └─────────────────┘    │
                             │                         │
                             └─────────────────────────┘


┌────────────────────────────────────────────────────────────────────────────────┐
│                              エントリーステータス遷移                              │
└────────────────────────────────────────────────────────────────────────────────┘

    ┌─────────────┐
    │    投稿     │
    │  (Submit)   │
    └──────┬──────┘
           │
           ▼
    ┌─────────────┐         ┌─────────────┐
    │   pending   │────────>│  rejected   │
    │  (審査待ち)  │  却下    │   (却下)    │
    └──────┬──────┘         └─────────────┘
           │                       │
           │ 承認                   │ 再審査
           ▼                       │
    ┌─────────────┐<───────────────┘
    │  approved   │
    │   (承認)    │
    └──────┬──────┘
           │
           │ 受賞選定
           ▼
    ┌─────────────┐
    │   winner    │
    │   (受賞)    │
    └─────────────┘
```
