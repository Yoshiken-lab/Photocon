# フォトコンテストシステム 要件仕様書

## 1. システム概要

### 1.1 システム名
**スクールフォト! フォトコンテストシステム**

### 1.2 目的
子供の写真を対象としたフォトコンテストを運営するためのWebシステム。
写真の投稿・収集、審査、投票、ランキング表示を一元管理する。

### 1.3 技術スタック
| 項目 | 技術 |
|------|------|
| フレームワーク | Next.js 14 (App Router) |
| 言語 | TypeScript 5.x |
| UI | React 18, Tailwind CSS |
| データベース | Supabase (PostgreSQL) |
| ストレージ | Supabase Storage |
| 外部連携 | Instagram Graph API |
| ホスティング | Vercel |

---

## 2. 機能要件

### 2.1 ユーザー向け機能

#### 2.1.1 作品投稿機能
| 項目 | 詳細 |
|------|------|
| 機能概要 | ユーザーが写真をアップロードして応募 |
| 入力項目 | ニックネーム（必須）、メールアドレス（必須）、タイトル、説明、写真ファイル |
| ファイル制限 | 最大10MB、画像ファイルのみ（JPEG, PNG, GIF, WebP） |
| 処理 | Supabase Storageに保存、DBにエントリー登録（status: pending） |

#### 2.1.2 ギャラリー閲覧機能
| 項目 | 詳細 |
|------|------|
| 機能概要 | 承認済み作品の一覧表示 |
| 表示項目 | 写真、ニックネーム、いいね数、カテゴリ |
| フィルタ | カテゴリ別絞り込み |
| ソート | 新着順 / 人気順 |
| 詳細表示 | ライトボックスモーダルで拡大表示 |

#### 2.1.3 投票機能
| 項目 | 詳細 |
|------|------|
| 機能概要 | 気に入った作品に投票 |
| 投票制限 | 1作品につき1IP1票（SHA256ハッシュで重複防止） |
| 投票期間 | コンテストの投票開始〜終了日時で制御 |
| 表示 | 投票数のリアルタイム更新 |

#### 2.1.4 ランキング機能
| 項目 | 詳細 |
|------|------|
| 機能概要 | 投票数上位20作品を表示 |
| 表示項目 | 順位、写真、投票数、バッジ（1位:王冠、2-3位:メダル） |

### 2.2 管理者向け機能

#### 2.2.1 ダッシュボード
| 項目 | 詳細 |
|------|------|
| 統計情報 | 総エントリー数、審査待ち数、承認済み数、総投票数 |
| 最新投稿 | 直近5件の投稿をサムネイル表示 |

#### 2.2.2 エントリー管理
| 項目 | 詳細 |
|------|------|
| 一覧表示 | 全エントリーをテーブル形式で表示 |
| フィルタ | ステータス別（pending/approved/rejected） |
| 操作 | 承認、却下、再審査 |
| 表示項目 | サムネイル、ニックネーム、カテゴリ、いいね数、ステータス |

#### 2.2.3 コンテスト管理
| 項目 | 詳細 |
|------|------|
| 一覧表示 | 全コンテストの一覧 |
| 表示項目 | 名称、期間、ハッシュタグ、ステータス、カテゴリ |
| ステータス | draft（下書き）、active（開催中）、voting（投票中）、ended（終了） |

#### 2.2.4 Instagram収集機能
| 項目 | 詳細 |
|------|------|
| 自動収集 | Vercel Cronで定期実行 |
| 手動収集 | 管理画面からトリガー可能 |
| 収集対象 | コンテストに設定されたハッシュタグの投稿 |
| 処理 | 日付範囲フィルタ、カテゴリ自動割当、重複排除 |

---

## 3. データベース設計

### 3.1 テーブル構成

#### contests（コンテスト）
| カラム | 型 | 説明 |
|--------|-----|------|
| id | uuid | 主キー |
| name | text | コンテスト名 |
| description | text | 説明 |
| hashtags | text[] | 監視するハッシュタグ配列 |
| start_date | timestamp | 開始日時 |
| end_date | timestamp | 終了日時 |
| voting_start | timestamp | 投票開始日時 |
| voting_end | timestamp | 投票終了日時 |
| status | text | draft/active/voting/ended |
| settings | jsonb | 設定情報 |
| created_at | timestamp | 作成日時 |
| updated_at | timestamp | 更新日時 |

#### categories（カテゴリ）
| カラム | 型 | 説明 |
|--------|-----|------|
| id | uuid | 主キー |
| contest_id | uuid | コンテストID（外部キー） |
| name | text | カテゴリ名 |
| hashtag | text | 対応ハッシュタグ |
| description | text | 説明 |
| sort_order | integer | 表示順 |
| created_at | timestamp | 作成日時 |

#### entries（エントリー）
| カラム | 型 | 説明 |
|--------|-----|------|
| id | uuid | 主キー |
| contest_id | uuid | コンテストID（外部キー） |
| category_id | uuid | カテゴリID（外部キー） |
| instagram_media_id | text | InstagramメディアID |
| instagram_permalink | text | Instagramパーマリンク |
| media_type | text | IMAGE/VIDEO/CAROUSEL_ALBUM |
| media_url | text | メディアURL |
| thumbnail_url | text | サムネイルURL |
| caption | text | キャプション |
| username | text | ユーザー名 |
| email | text | メールアドレス（非公開） |
| instagram_user_id | text | InstagramユーザーID |
| like_count | integer | いいね数 |
| comments_count | integer | コメント数 |
| status | text | pending/approved/rejected/winner |
| rejection_reason | text | 却下理由 |
| featured | boolean | 注目フラグ |
| instagram_timestamp | timestamp | Instagram投稿日時 |
| collected_at | timestamp | 収集日時 |
| updated_at | timestamp | 更新日時 |

#### votes（投票）
| カラム | 型 | 説明 |
|--------|-----|------|
| id | uuid | 主キー |
| entry_id | uuid | エントリーID（外部キー） |
| voter_identifier | text | 投票者識別子（SHA256ハッシュ） |
| created_at | timestamp | 投票日時 |

**制約**: (entry_id, voter_identifier) でユニーク

#### collection_logs（収集ログ）
| カラム | 型 | 説明 |
|--------|-----|------|
| id | uuid | 主キー |
| contest_id | uuid | コンテストID |
| hashtag | text | ハッシュタグ |
| posts_found | integer | 発見件数 |
| posts_added | integer | 追加件数 |
| posts_updated | integer | 更新件数 |
| error_message | text | エラーメッセージ |
| executed_at | timestamp | 実行日時 |

---

## 4. API設計

### 4.1 エンドポイント一覧

| メソッド | パス | 機能 |
|----------|------|------|
| GET | /api/contests | アクティブなコンテスト取得 |
| POST | /api/entries | 作品投稿 |
| GET | /api/votes?entryId=xxx | 投票状態確認 |
| POST | /api/votes | 投票実行 |
| GET/POST | /api/instagram/collect | Instagram収集（手動） |
| GET | /api/cron/collect | Instagram収集（自動） |

### 4.2 API詳細

#### POST /api/entries
**リクエスト**: FormData
- file: 画像ファイル（必須）
- contestId: コンテストID（必須）
- nickname: ニックネーム（必須）
- email: メールアドレス（必須）
- title: タイトル（任意）
- caption: 説明（任意）

**レスポンス**:
```json
{
  "success": true,
  "entry": { "id": "xxx", "media_url": "xxx" }
}
```

#### POST /api/votes
**リクエスト**:
```json
{
  "entryId": "entry-uuid"
}
```

**レスポンス**:
```json
{
  "success": true,
  "voteCount": 42
}
```

---

## 5. セキュリティ要件

### 5.1 データ保護
| 項目 | 対策 |
|------|------|
| メールアドレス | ユーザー画面では一切表示しない（PublicEntry型で除外） |
| 管理者操作 | Service Role Keyを使用（サーバーサイドのみ） |
| ファイルアップロード | サイズ・タイプ検証 |

### 5.2 不正投票防止
| 項目 | 対策 |
|------|------|
| 重複投票 | IP+エントリーIDのSHA256ハッシュで識別 |
| 投票期間 | コンテストの投票期間外は拒否 |
| ステータス | 承認済み作品のみ投票可能 |

### 5.3 Cron保護
| 項目 | 対策 |
|------|------|
| 認証 | Bearer Token（CRON_SECRET）による認証 |

---

## 6. 非機能要件

### 6.1 パフォーマンス
- ページ読み込み: 3秒以内
- API応答: 1秒以内
- 画像最適化: Next.js Image最適化使用

### 6.2 可用性
- Vercelによる自動スケーリング
- Supabaseのマネージドサービス利用

### 6.3 対応デバイス
- PC（Chrome, Firefox, Safari, Edge最新版）
- スマートフォン（iOS Safari, Android Chrome）
- レスポンシブデザイン対応

---

## 7. 環境変数

```env
# Supabase
NEXT_PUBLIC_SUPABASE_URL=
NEXT_PUBLIC_SUPABASE_ANON_KEY=
SUPABASE_SERVICE_ROLE_KEY=

# Instagram Graph API
INSTAGRAM_ACCESS_TOKEN=
INSTAGRAM_BUSINESS_ACCOUNT_ID=

# Cron
CRON_SECRET=
```

---

## 8. 将来拡張（未実装）

1. **管理者認証** - ログイン機能
2. **コンテスト作成UI** - 管理画面からの新規作成
3. **メール通知** - 受賞者への自動通知
4. **詳細分析** - アクセス解析ダッシュボード
5. **SNS連携** - Twitter/LINE共有機能
