# 🛠️ トラブルシューティング & 実装ログ (魂の記録)

このドキュメントは、プロジェクト開発中に遭遇した**不具合・エラー・壁**と、それを**どう乗り越えたか（解決策）**、そしてそこから得た**教訓**を記録するものである！！！！
未来の自分、そして新たな開発メンバーよ、これを読んで同じ轍を踏むな！！！！押忍！！！！

---

## 📅 2026-01-26

### 1. Next.js Hydration Error (ランダム数値の不一致)
- **事象**:
    - `page.tsx` で `Math.random()` を使用してモックデータを生成していた際、サーバー側で生成されたHTMLと、ブラウザ側で生成されたHTMLの内容（数値）が食い違い、画面が真っ白になる（またはエラーが出る）現象が発生。
    - エラーメッセージ: `Text content does not match server-rendered HTML.`
- **原因**:
    - Next.js (App Router) はサーバーとクライアントの両方でレンダリングを行うが、`Math.random()` は毎回異なる値を返すため、両者の整合性が取れなくなる。
- **解決策（魂の拳）**:
    - ランダムではなく、**決定的な計算式**を使用してデータを生成するように変更。
    - 例: `const entries = ((index * 1237 + 7) % 300) + 50`
    - これにより、何度実行しても同じインデックスに対しては同じ数値が生成され、整合性が保たれる！
- **教訓**:
    - **「Hydration (水分補給) にランダム（不純物）を混ぜるな！！！！」**
    - モックデータ生成時は一貫性を意識せよ。

### 2. PC表示での「モバイルファースト」崩れ
- **事象**:
    - スマホ向けに作成したデザイン案 (`grid-cols-1` 等) をPCのブラウザで開いた際、画面幅いっぱいに要素が広がり、間延びした無様なレイアウトになってしまった。
- **原因**:
    - コンテナの `max-width` 制限を設け忘れていたため。Sample O は「PCでもスマホアプリのように見える」コンセプトであることを失念していた。
- **解決策**:
    - 全体のラッパー要素にクラスを追加し、強制的にスマホサイズ感を維持！
    - `w-full md:max-w-[600px] mx-auto border-x`
- **教訓**:
    - **「己のコンセプト（モバイルファースト）を見失うな！！！！」**
    - 常に広い画面でどう見えるかを想像し、適切な制約（リミッター）をかけろ。

### 3. Voting State Persistence (投票状態の消失)
- **事象**:
    - 投票ボタンを押して「投票済み（ピンク）」になった後、ページをリロードすると「未投票（青）」に戻ってしまう。
    - 実際にはサーバー側で投票が記録されているため、次にボタンを押すと「投票解除（削除）」処理が走り、見た目は「未投票→未投票」となり何も起きていないように見えるバグが発生。
- **原因**:
    - クライアント側（ブラウザ）がページロード時に、サーバー上の「自分の投票履歴」を取得して同期する処理が抜けていた。
    - また、`getMyVotes` 関数が部分的なデータ取得を行っており、正しくデータを返せていないケースがあった。
- **解決策**:
    - マウント時 (`useEffect`) に `getMyVotes` を呼び出し、サーバーから最新の状態を取得・同期するように修正。
    - `getMyVotes` を `select('*')` に変更し、確実にデータを取得できるよう強化。
- **教訓**:
    - **「記憶（State）は儚い。記録（DB）を信じろ！！！！」**
    - ユーザーのアクション結果は必ず永続化し、ロード時に復元せよ。

### 4. TypeScript Implicit Any / Never Error (Supabase型推論の敗北)
- **事象**:
    - `sample-o.ts` で `Property 'id' does not exist on type 'never'` 等のエラーが大量発生。
    - SupabaseクライアントがDBスキーマを正しく推論できず、結果が `never` 型になってしまっていた。
- **原因**:
    - 具体的な原因は不明だが、環境設定や複雑な型定義の中で推論チェーンが切れた可能性がある。
- **解決策（最終奥義）**:
    - **「型アサーション (`as unknown as RowType[]`)」** を適用し、TypeScriptに型を強制的に認めさせた。
    - また、クエリチェーン自体も `(supabase.from(...) as any)` とキャストすることで、`insert/update` 時の `never` パラメータエラーもねじ伏せた。
- **教訓**:
    - **「推論が駄目なら明示しろ！！！！」**
    - TypeScriptの機嫌取りに時間をかけすぎるな。時には力技（アサーション）で押し通す決断も必要だ。

### 5. Browser Tool Environment Error ($HOME variable)
- **事象**:
    - エージェントがブラウザを使おうとした際、`failed to create browser context: failed to install playwright: $HOME environment variable is not set` というエラーで起動不能になった。
- **原因**:
    - システム環境変数 `$HOME` が設定されていないため、Playwrightが必要なファイルを展開できなかった模様。
- **解決策**:
    - ブラウザツールの使用を断念し、サーバーログ (`read_terminal`) や静的解析 (`read_url_content`) で代用・調査を進めた。
- **教訓**:
    - **「道具（ツール）に頼りすぎるな！！！！」**
    - 便利なツールが使えない時こそ、エンジニアの基礎力（ログ読み、推測）が試される。

---

## 📅 2026-01-23

### 6. Git 'nul' ファイル エラー
- **事象**:
    - `git add .` を実行した際、`fatal: adding files failed` となりコミットができない事態が発生。
    - エラーログに `unable to index file 'nul'` という不穏な記述あり。
- **原因**:
    - Windows環境において `nul` はシステム予約語（デバイスファイル）であり、ファイル名として使用できない。
    - 恐らく何らかの自動生成ツールか誤操作で `nul` というファイルが紛れ込んだ（あるいはGitがそう誤認した）。
- **解決策**:
    - `git add .` (全追加) を避け、**変更したファイルを明示的に指定して add する**ことで回避。
    - `git add path/to/file`
- **教訓**:
    - **「Windowsの予約語（nul, con, prn, aux...）は地雷原だと思え！！！！」**
    - 怪しいエラーが出たら、横着せずに個別対応で切り抜けろ！

### 7. CSS `@import` 順序エラー
- **事象**:
    - ビルド時に `Expected '@import' to be first-level node` のような警告/エラーが発生。
- **原因**:
    - CSSファイル内で `@import` 文よりも先に通常のスタイル定義を書いていたため（CSS仕様違反）。
- **解決策**:
    - すべての `@import` 文をファイルの**最上部（1行目〜）** に移動。
- **教訓**:
    - **「挨拶（インポート）は最初にするのが礼儀！！！！」**
    - 基本的なCSS構文ルールを軽視するべからず。

### 8. React Select `defaultValue` 警告
- **事象**:
    - コンソールに `Use the defaultValue or value props on <select> instead of setting selected on <option>` という警告が出現。
- **原因**:
    - Reactでは `<option selected>` ではなく、親の `<select>` タグあるいは `value/defaultValue` プロップで初期値を制御するのが作法であるため。
- **解決策**:
    - `<option selected>` を削除し、`<select defaultValue="">` を設定。
- **教訓**:
    - **「Reactの作法（流儀）を守れ！！！！」**
    - HTMLの常識が通用しないこともある。郷に入っては郷に従え。

### 9. Syntax Error (Unexpected token `div`)
- **事象**:
    - `apply/page.tsx` の修正後、`Unexpected token div` という謎のエラーが消えない。
    - コード上の見た目は正しい JSX に見えるが、コンパイラが拒絶する。
- **原因**:
    - 編集ツールによるコード置換時に、**閉じタグ `</div>` や `}` が不足**していたり、見えない制御文字が混入していた可能性が高い。
    - 特に `if (success) { return (...) }` のようなブロックごとの置換で、前後の整合性が崩れた。
- **解決策**:
    - **「疑わしきは全削除して書き直せ！！！！」**
    - 部分的な修正ではなく、そのブロック全体（`if`文ごと）をクリーンなコードで完全に上書きすることで解消。
- **教訓**:
    - エラー箇所をちまちま直すより、ブロック単位でガツンと直したほうが早いこともある！

### 10. 背景色デザインの認識齟齬
- **事象**:
    - 「背景を白にして」という指示に対し、すべての背景を白にしてしまい、コンテンツの境界が見えなくなってしまった。
    - ユーザーの意図は「PCの余白は白、コンテンツは元の色（オレンジ）」だった。
- **原因**:
    - **「コンテキスト（文脈）の読み解き不足！！！！」**
    - PCビューとスマホビューの違い、そして「メリハリ」というデザイン意図を深く理解せずに作業してしまった。
- **解決策**:
    - `Layout` (大枠) は白、`Container` (中身) はカスタム色、という入れ子構造を明確に実装。
- **教訓**:
    - **「木を見て森を見ずになるな！！！！」**
    - 指示の裏にある「なぜそうしたいのか（見やすさ、デザイン性）」を常に想像せよ。

### 11. ReferenceError: getMyVotes is not defined (インポート漏れ)
- **事象**:
    - `ResultClientO.tsx` を修正して `getMyVotes` を呼び出すようにしたが、コンソールに `ReferenceError: getMyVotes is not defined` が表示され、処理が落ちる。
- **原因**:
    - 関数を使用するコードは書いたが、その関数の **import文 (`import { getMyVotes } from ...`) を書き忘れていた**。
    - エディタの自動インポートに頼りすぎて、手動修正時の確認が疎かになった。
- **解決策**:
    - `import { voteForEntry, getMyVotes } from '@/app/actions/sample-o'` のように、正しくインポートを追加。
- **教訓**:
    - **「使ったら呼べ（Import）！！！！」**
    - コピペや手動修正の後は、必ずインポートセクションを確認せよ。Lintエラーが出ていないか（あるいは無視していないか）要チェック。

### 12. ReferenceError: Send is not defined (コンポーネントインポート漏れ)
- **事象**:
    - お問い合わせページの送信ボタンのアイコンを `<Send />` に変更したが、画面が真っ白になり `ReferenceError: Send is not defined` が発生。
- **原因**:
    - `lucide-react` から `Send` コンポーネントを使用するように JSX を書き換えたが、**上部の import 文に追加するのを忘れていた**。
    - ツールによる一括置換時に、import部分の置換を含めていたつもりが、適用範囲の指定ミス等でうまく反映されていなかった可能性もある。
- **解決策**:
    - `import { ArrowLeft, Send } from 'lucide-react'` に修正。
- **教訓**:
    - **「見た目だけ変えて中身（Import）忘れるな！！！！」**
    - コンポーネントを追加したら、息をするようにインポートを確認せよ。

---

*これからも壁にぶち当たったら、ここに傷跡（ログ）を残していくこととする！！！！以上！！！！*
