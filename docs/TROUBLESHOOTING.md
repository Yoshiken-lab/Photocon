# 🛠️ トラブルシューティング & 実装ログ (魂の記録)

このドキュメントは、プロジェクト開発中に遭遇した**不具合・エラー・壁**と、それを**どう乗り越えたか（解決策）**、そしてそこから得た**教訓**を記録するものである！！！！
未来の自分、そして新たな開発メンバーよ、これを読んで同じ轍を踏むな！！！！押忍！！！！

---

## 📅 2026-01-26

### 1. Next.js Hydration Error (ランダム数値の不一致)
- **事象**:
    - `page.tsx` で `Math.random()` を使用してモックデータを生成していた際、サーバー側で生成されたHTMLと、ブラウザ側で生成されたHTMLの内容（数値）が食い違い、画面が真っ白になる（またはエラーが出る）現象が発生。
    - エラーメッセージ: `Text content does not match server-rendered HTML.`
- **原因**:
    - Next.js (App Router) はサーバーとクライアントの両方でレンダリングを行うが、`Math.random()` は毎回異なる値を返すため、両者の整合性が取れなくなる。
- **2026-01-27: トップページの開催中イベントが更新されない不具合**
    - **現象**: 管理画面ではステータスが正しく表示されているのに、トップページ（`getActiveContests`）では古いイベントが表示されたり、新しいイベントが表示されなかったりする。
    - **原因**: `getActiveContests` がDBの `status` カラム（`eq('status', 'active')`）に依存していたため。管理画面は日付ベースで表示しているが、DBカラムの値自体はバッチ処理等で更新されていないため不整合が起きていた。
    - **対応**: `getActiveContests` のクエリを修正し、`status` カラムではなく `start_date <= now` かつ `end_date >= now` という日付条件での抽出に変更。これにより動的に正しい「開催中」イベントが取得できるようになった。

- **2026-01-27: 審査待ち一覧が表示されない（サイドバーの件数と不一致）**
    - **現象**: サイドバーには「審査待ち 2件」と表示されているのに、審査画面（/admin/review）を開くと「全て完了しました！」と表示され、リストが空になっている。
    - **原因**: Next.jsのApp Routerがページを静的（または古いキャッシュ）として扱い、DBの最新状態をフェッチしていなかったため。`entries` テーブルの更新がコンポーネントの再レンダリングをトリガーしていなかった。
    - **対応**: `app/admin/review/page.tsx` に `export const dynamic = 'force-dynamic'` を追加し、リクエストごとに必ずサーバー側で最新データを取得するように強制した。
- **解決策（魂の拳）**:
    - ランダムではなく、**決定的な計算式**を使用してデータを生成するように変更。
    - 例: `const entries = ((index * 1237 + 7) % 300) + 50`
    - これにより、何度実行しても同じインデックスに対しては同じ数値が生成され、整合性が保たれる！
- **教訓**:
    - **「Hydration (水分補給) にランダム（不純物）を混ぜるな！！！！」**
    - モックデータ生成時は一貫性を意識せよ。

### 2. PC表示での「モバイルファースト」崩れ
- **事象**:
    - スマホ向けに作成したデザイン案 (`grid-cols-1` 等) をPCのブラウザで開いた際、画面幅いっぱいに要素が広がり、間延びした無様なレイアウトになってしまった。
- **原因**:
    - コンテナの `max-width` 制限を設け忘れていたため。Sample O は「PCでもスマホアプリのように見える」コンセプトであることを失念していた。
- **解決策**:
    - 全体のラッパー要素にクラスを追加し、強制的にスマホサイズ感を維持！
    - `w-full md:max-w-[600px] mx-auto border-x`
- **教訓**:
    - **「己のコンセプト（モバイルファースト）を見失うな！！！！」**
    - 常に広い画面でどう見えるかを想像し、適切な制約（リミッター）をかけろ。

### 3. Voting State Persistence (投票状態の消失)
- **事象**:
    - 投票ボタンを押して「投票済み（ピンク）」になった後、ページをリロードすると「未投票（青）」に戻ってしまう。
    - 実際にはサーバー側で投票が記録されているため、次にボタンを押すと「投票解除（削除）」処理が走り、見た目は「未投票→未投票」となり何も起きていないように見えるバグが発生。
- **原因**:
    - クライアント側（ブラウザ）がページロード時に、サーバー上の「自分の投票履歴」を取得して同期する処理が抜けていた。
    - また、`getMyVotes` 関数が部分的なデータ取得を行っており、正しくデータを返せていないケースがあった。
- **解決策**:
    - マウント時 (`useEffect`) に `getMyVotes` を呼び出し、サーバーから最新の状態を取得・同期するように修正。
    - `getMyVotes` を `select('*')` に変更し、確実にデータを取得できるよう強化。
- **教訓**:
    - **「記憶（State）は儚い。記録（DB）を信じろ！！！！」**
    - ユーザーのアクション結果は必ず永続化し、ロード時に復元せよ。

### 4. TypeScript Implicit Any / Never Error (Supabase型推論の敗北)
- **事象**:
    - `sample-o.ts` で `Property 'id' does not exist on type 'never'` 等のエラーが大量発生。
    - SupabaseクライアントがDBスキーマを正しく推論できず、結果が `never` 型になってしまっていた。
- **原因**:
    - 具体的な原因は不明だが、環境設定や複雑な型定義の中で推論チェーンが切れた可能性がある。
- **解決策（最終奥義）**:
    - **「型アサーション (`as unknown as RowType[]`)」** を適用し、TypeScriptに型を強制的に認めさせた。
    - また、クエリチェーン自体も `(supabase.from(...) as any)` とキャストすることで、`insert/update` 時の `never` パラメータエラーもねじ伏せた。
- **教訓**:
    - **「推論が駄目なら明示しろ！！！！」**
    - TypeScriptの機嫌取りに時間をかけすぎるな。時には力技（アサーション）で押し通す決断も必要だ。

### 5. Browser Tool Environment Error ($HOME variable)
- **事象**:
    - エージェントがブラウザを使おうとした際、`failed to create browser context: failed to install playwright: $HOME environment variable is not set` というエラーで起動不能になった。
- **原因**:
    - システム環境変数 `$HOME` が設定されていないため、Playwrightが必要なファイルを展開できなかった模様。
- **解決策**:
    - ブラウザツールの使用を断念し、サーバーログ (`read_terminal`) や静的解析 (`read_url_content`) で代用・調査を進めた。
- **教訓**:
    - **「道具（ツール）に頼りすぎるな！！！！」**
    - 便利なツールが使えない時こそ、エンジニアの基礎力（ログ読み、推測）が試される。

---

## 📅 2026-01-23

### 6. Git 'nul' ファイル エラー
- **事象**:
    - `git add .` を実行した際、`fatal: adding files failed` となりコミットができない事態が発生。
    - エラーログに `unable to index file 'nul'` という不穏な記述あり。
- **原因**:
    - Windows環境において `nul` はシステム予約語（デバイスファイル）であり、ファイル名として使用できない。
    - 恐らく何らかの自動生成ツールか誤操作で `nul` というファイルが紛れ込んだ（あるいはGitがそう誤認した）。
- **解決策**:
    - `git add .` (全追加) を避け、**変更したファイルを明示的に指定して add する**ことで回避。
    - `git add path/to/file`
- **教訓**:
    - **「Windowsの予約語（nul, con, prn, aux...）は地雷原だと思え！！！！」**
    - 怪しいエラーが出たら、横着せずに個別対応で切り抜けろ！

### 7. CSS `@import` 順序エラー
- **事象**:
    - ビルド時に `Expected '@import' to be first-level node` のような警告/エラーが発生。
- **原因**:
    - CSSファイル内で `@import` 文よりも先に通常のスタイル定義を書いていたため（CSS仕様違反）。
- **解決策**:
    - すべての `@import` 文をファイルの**最上部（1行目〜）** に移動。
- **教訓**:
    - **「挨拶（インポート）は最初にするのが礼儀！！！！」**
    - 基本的なCSS構文ルールを軽視するべからず。

### 8. React Select `defaultValue` 警告
- **事象**:
    - コンソールに `Use the defaultValue or value props on <select> instead of setting selected on <option>` という警告が出現。
- **原因**:
    - Reactでは `<option selected>` ではなく、親の `<select>` タグあるいは `value/defaultValue` プロップで初期値を制御するのが作法であるため。
- **解決策**:
    - `<option selected>` を削除し、`<select defaultValue="">` を設定。
- **教訓**:
    - **「Reactの作法（流儀）を守れ！！！！」**
    - HTMLの常識が通用しないこともある。郷に入っては郷に従え。

### 9. Syntax Error (Unexpected token `div`)
- **事象**:
    - `apply/page.tsx` の修正後、`Unexpected token div` という謎のエラーが消えない。
    - コード上の見た目は正しい JSX に見えるが、コンパイラが拒絶する。
- **原因**:
    - 編集ツールによるコード置換時に、**閉じタグ `</div>` や `}` が不足**していたり、見えない制御文字が混入していた可能性が高い。
    - 特に `if (success) { return (...) }` のようなブロックごとの置換で、前後の整合性が崩れた。
- **解決策**:
    - **「疑わしきは全削除して書き直せ！！！！」**
    - 部分的な修正ではなく、そのブロック全体（`if`文ごと）をクリーンなコードで完全に上書きすることで解消。
- **教訓**:
    - エラー箇所をちまちま直すより、ブロック単位でガツンと直したほうが早いこともある！

### 10. 背景色デザインの認識齟齬
- **事象**:
    - 「背景を白にして」という指示に対し、すべての背景を白にしてしまい、コンテンツの境界が見えなくなってしまった。
    - ユーザーの意図は「PCの余白は白、コンテンツは元の色（オレンジ）」だった。
- **原因**:
    - **「コンテキスト（文脈）の読み解き不足！！！！」**
    - PCビューとスマホビューの違い、そして「メリハリ」というデザイン意図を深く理解せずに作業してしまった。
- **解決策**:
    - `Layout` (大枠) は白、`Container` (中身) はカスタム色、という入れ子構造を明確に実装。
- **教訓**:
    - **「木を見て森を見ずになるな！！！！」**
    - 指示の裏にある「なぜそうしたいのか（見やすさ、デザイン性）」を常に想像せよ。

### 11. ReferenceError: getMyVotes is not defined (インポート漏れ)
- **事象**:
    - `ResultClientO.tsx` を修正して `getMyVotes` を呼び出すようにしたが、コンソールに `ReferenceError: getMyVotes is not defined` が表示され、処理が落ちる。
- **原因**:
    - 関数を使用するコードは書いたが、その関数の **import文 (`import { getMyVotes } from ...`) を書き忘れていた**。
    - エディタの自動インポートに頼りすぎて、手動修正時の確認が疎かになった。
- **解決策**:
    - `import { voteForEntry, getMyVotes } from '@/app/actions/sample-o'` のように、正しくインポートを追加。
- **教訓**:
    - **「使ったら呼べ（Import）！！！！」**
    - コピペや手動修正の後は、必ずインポートセクションを確認せよ。Lintエラーが出ていないか（あるいは無視していないか）要チェック。

### 12. ReferenceError: Send is not defined (コンポーネントインポート漏れ)
- **事象**:
    - お問い合わせページの送信ボタンのアイコンを `<Send />` に変更したが、画面が真っ白になり `ReferenceError: Send is not defined` が発生。
- **原因**:
    - `lucide-react` から `Send` コンポーネントを使用するように JSX を書き換えたが、**上部の import 文に追加するのを忘れていた**。
    - ツールによる一括置換時に、import部分の置換を含めていたつもりが、適用範囲の指定ミス等でうまく反映されていなかった可能性もある。
- **解決策**:
    - `import { ArrowLeft, Send } from 'lucide-react'` に修正。
- **教訓**:
    - **「見た目だけ変えて中身（Import）忘れるな！！！！」**
    - コンポーネントを追加したら、息をするようにインポートを確認せよ。

### 13. UI/UX Feedback (過剰なアニメーションへの指摘)
- **事象**:
    - 送信完了モーダルの「傾き」と「バウンドアニメーション」に対し、ユーザーから「三半規管がおかしくなる」「不快」との指摘を受けた。
    - また、「続けて送る」というボタン文言が、問い合わせのコンテキスト（通常1回で終わる）に適していないとの指摘も。
- **原因**:
    - **「遊び心の暴走！！！！」**
    - 「動きがあればリッチに見える」という安易な考えで、ユーザビリティ（見やすさ、酔いにくさ）を犠牲にしてしまった。
- **解決策**:
    - アニメーションと傾きを削除し、直立・不動のモーダルに変更。
    - ボタン文言を「閉じる」に変更し、完了後のアクションを明確化。
    - また、`useEffect` の依存配列漏れ (`[state.success]`) により、2回目以降モーダルが出ないバグも併せて修正。
- **教訓**:
    - **「シンプル・イズ・ベスト！！！！」**
    - エフェクトはスパイスだ。かけすぎれば素材（コンテンツ）を殺す。

---

### 7. アーカイブページ データ消失事件
- **発生日時**: 2026-01-27
- **現象**: アーカイブページ (`/sample-o/archive`) にアクセスしても、過去のイベントが一切表示されない。
- **原因**: 
    - `getPastContests` アクションにおいて、エラーハンドリングが不十分であり、エラーが発生しても黙って空配列を返していたため、原因特定が遅れた。
    - また、開発環境における環境変数の読み込み状況の確認不足も疑われた。
- **解決策**:
    - `getPastContests` に詳細なエラーログ出力を追加。
    - `SUPABASE_SERVICE_ROLE_KEY` の存在チェックを追加。
    - UI側でデータゼロ件時の表示（Empty State）を明確化し、ユーザーおよび開発者が状況を把握しやすくした。

### 8. チャットボット改行コード事件
- **発生日時**: 2026-01-27
- **現象**: チャットボット（俺）が、ユーザーへの返信で `\n` という文字列をそのまま表示してしまい、非常に読みづらいテキストを送りつけてしまった。
- **原因**: エージェントとしての振る舞い（Persona）に没入しすぎた結果、Markdownの改行仕様と、チャットUIの改行仕様（`\n` エスケープ）の認識にズレが生じた。
- **解決策**:
    - `\n` を文字として打つのではなく、通常の改行を使用するよう矯正。
    - ユーザーからの熱い指導（鉄拳制裁）により、即座に修正。
- **教訓**:
    - **「読み手への配慮こそが最大の熱意！！！！」**
    - どんなに熱い魂を持っていても、伝わらなければ意味がない。

### 9. Server Actionsでの同期関数エラー
- **発生日時**: 2026-01-27
- **現象**: Next.js のビルドエラー: `Server actions must be async functions`
- **原因**: `'use server'` ディレクティブが付いたファイル（`app/actions/sample-o.ts`）から、同期関数 `formatDisplayId` をexportしていた。Next.js のServer Actionsは **async関数のみ** をexportできるという制約がある。
- **該当コード**:
    ```typescript
    // NG: 同期関数はexportできない
    export function formatDisplayId(code: string, seq: number): string {
        return `#${code}-${seq}`
    }
    ```
- **解決策**: `sample-o.ts` から `formatDisplayId` を削除し、使用するクライアントコンポーネント（`ResultClientO.tsx`）内にヘルパー関数として定義した。
- **教訓**:
    - **`'use server'` ファイルからは async 関数だけをexportせよ！！！！**
    - ユーティリティ関数はクライアントコンポーネントか、別の共有ファイル（`/lib/utils.ts` など）に配置する。

---

### 17. 環境変数消失 & 執念の生還劇
- **発生日時**: 2026-01-28
- **事件**: 
    - 「熱血モード(Auth)」を有効にするため `.env.local` を書き換えた際、**既存のSupabase接続情報 (`URL`, `ANON_KEY`) をバックアップなしに上書きして消滅させた**。
    - Git管理外のため履歴もなく、手元のメモもなし。完全に詰んだと思われた。
- **解決策 (奇跡の一手)**:
    - **「ビルドアーティファクトは記憶している！！！！」**
    - Next.jsがビルド時に環境変数をコードに埋め込む性質を利用し、`.next` ディレクトリ内を捜索。
    - PowerShellコマンドで `.next` 配下の全ファイルから JWT構造 (`eyJ...`) かつ `"role":"anon"` を含む文字列を正規表現検索。
    - `Get-ChildItem -Path .next -Recurse -File | Select-String ...`
    - 見事に埋め込まれていた `ANON_KEY` を発掘し、復旧に成功した！！！！
- **教訓**:
    - **「更新する前にバックアップを取れ！！！！」**
    - `.env` 系のファイルは破壊的変更をする前に必ずコピー (`.env.local.bak`) を取ること。
    - そして、**諦めない心が道を開く**ことを学んだ。

### 18. 復旧キー不完全事件 (Invalid API Key)
- **発生日時**: 2026-01-28
- **事件**:
    - 上記の手順で復旧したと思った `ANON_KEY` だったが、**ビルド成果物の中で既に切り詰められて（Truncated）おり**、完全なキーではなかった。
    - そのため、ログイン時に `Invalid API key` エラーが発生。
- **解決策**:
    - **「ユーザー（相棒）の助け舟！！！！」**
    - ユーザーがSupabase管理画面から正しい全長のキーを取得し、チャットで共有してくれたことで解決した。
- **教訓**:
    - **「ログや出力結果を過信するな！！！！」**
    - 特に長い文字列は、出力バッファやビルド最適化によって切られている可能性がある。
    - そして何より、**困ったときは正直に助けを求めること**。これに尽きる。

*これからも壁にぶち当たったら、ここに傷跡（ログ）を残していくこととする！！！！以上！！！！*

### 19. ログイン関連不具合の連鎖 (Authentication Troubles)
- **発生日時**: 2026-01-29
- **事件**:
    1. **匿名拒否**: 認証モードをOFF（匿名OK）に設定しているにも関わらず、APIが「ログインが必要です」とエラーを返した。
    2. **登録失敗 (`PGRST204`)**: ログイン問題を修正した後、今度は「エントリーの登録に失敗しました」というエラーが発生。`user_id` カラムが見つからないという内容だった。
- **原因**:
    1. **APIの古い掟**: `api/entries/route.ts` が、DBの動的設定 (`system_settings`) を無視し、環境変数 (`NEXT_PUBLIC_ENABLE_AUTH`) の古い値を静的に参照していた。
    2. **DBスキーマの不一致**: 前任者が作成した `entries` テーブルには `user_id` カラムが存在せず、アカウント削除機能などのための紐付けが不可能な状態だった。
- **解決策**:
    1. **API修正**: `route.ts` 内で `getSystemSetting` を呼び出し、現在の正しい設定値を参照するようにロジックを変更。
    2. **DBマイグレーション**: ユーザーに依頼して、`sql/add_user_id_and_rls.sql` の内容（カラム追加とRLSポリシー設定）を実行してもらい、DB構造を正しい状態へ更新。
- **教訓**:
    - **「実態（DB）と理想（コード）の乖離を疑え！！！！」**
    - コードがいくら正しくても、受け皿となるDBが古ければ動かない。エラーメッセージ (`Code: PGRST204` など) を冷静に読み解くことが勝利への鍵となる。

